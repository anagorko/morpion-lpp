% !TEX root = morpion5d.tex

\newcommand{\D}{\mathcal{D}}
\renewcommand{\ord}{\operatorname{ord}}
\newcommand{\mv}{\operatorname{mv}}
\renewcommand{\dt}{\operatorname{dt}}
\renewcommand{\L}[1]{{\sffamily L\textsubscript{#1}}}

\section{Morpion Solitaire via Linear Programming}
\label{sec:linear}

Let $\Cross \subset \mathbb{Z}^2$ be a set of $36$ dots that form an initial cross of Morpion Solitaire.
Let $\D = \{ (1, 0), (1,1), (0,1), (-1,1) \} \subset \mathbb{Z}^2$. We call elements of $\D$ \emph{directions}.
An unordered pair $\{ u, v \} \subset \mathbb{Z}^2$ is a \emph{unit edge} if $u - v \in \D$ or $v - u \in \D$.
We call $G = (V, E)$  a \emph{lattice graph} if $V \subset \mathbb{Z}^2$
      and each edge of $G$ is a unit edge.

%  We shall use the following notions.
%\begin{definition}
%The maximum metric in the square grid $\mathbb{Z}^2$ is defined as $\max (|s_1^1-s_2^1|,|s_1^2-s_2^2|)$
%for $s_1,s_2\in \mathbb{Z}^2$. 
%A \emph{unit segment} is a pair of points $\{s_1,s_2\}\in \mathbb{Z}^2$ in distance $1$ in the maximum metric. % $s_1\neq s_2$, $s_i = (s_i^1,s_i^2)$, $i=1,2$
 %such that $\max{|s_1^1-s_2^1|,|s_1^2-s_2^2|}=1$. That is, a unit segment is a pair of points in the
%in the square grid $\mathbb{Z}^2$ of length $1$ in the $\ell_\infty$ metric.
%\end{definition}


%\begin{definition} 

A move $m$ with a starting vertex $v \in \mathbb{Z}^2$ and direction $d \in \D$ is the set
$
   m = \{ v + n \cdot d \colon n \in \{ 0, 1, 2, 3, 4 \} \}.
$
The set of all moves is denoted by $\mathcal{M}$.
We say that moves are \emph{parallel} if they have the same direction.
We let $E(m)$ denote the set $\{ \{ v + n \cdot d, v + (n+1) \cdot d \} \colon n \in \{0, 1, 2, 3 \} \}$
    We let
    $
      \mathcal{M}(G) = \{ m \in \mathcal{M} \colon E(m) \subset E \}
    $.
     We call $\mathcal{M}(G)$ the set of \emph{moves in $G$}.

%Let 
%    $
%      \mathcal{M} = \{ \{ \{s_1, s_2\}, \{s_2, s_3\}, \{s_3, s_4\}, \{s_4, s_5\} \} \colon s_i \in \mathbb{Z}^2, s_{i+1} - s_i = s_i - s_{i-1} \}.
%    $
 %   Elements of $\mathcal{M}$ are called \emph{moves}. 
%Notice, that moves consists of four consecutive, distinct, parallel unit segments that intersect at endpoints. 

%Up to a sign, a given move has one of four directions $(1,0)$, $(0,1)$, $(1,1)$, $(1,-1)$ determined by
%the difference $s_{2} - s_1 = s_3 - s_2 = s_4 - s_3 = s_5 - s_4$. 
%We call two moves $\{ \{s_1, s_2\}, \{s_2, s_3\}, \{s_3, s_4\}, \{s_4, s_5\} \}$ and $\{ \{t_1, t_2\}, \{t_2, t_3\}, \{t_3, t_4\}, \{t_4, t_5\} \}$ 
%in $\mathcal{M}$ {\em parallel} if $s_1-s_2 = \pm (t_1-t_2)$.  
% \end{definition}

\subsection{Definition of Morpion 5D graphs}

Below we define a concept of a marked Morpion 5D graph, which is a lattice graph with a special marking of vertices. Every Morpion 5D position is a marked Morpion 5D graph, but as we discuss below, there are marked Morpion 5D graphs not related to any Morpion 5D position.

In the following 
four definitions  $G = (V, E)$ is a fixed graph. 

\begin{definition} 
We say that the set $\mathcal{M}(G)$ of moves in $G$ is \emph{5D-disjoint}
if for every parallel moves $m_1, m_2 \in \mathcal{M}(G)$ the intersection of $m_1$ with $m_2$ is empty, i.e. parallel moves are vertex disjoint.
\end{definition}

\begin{definition} 
We say that the set $\mathcal{M}(G)$ of moves in $G$ \emph{covers} $E$ if 
  $\bigcup_{m \in \mathcal{M}(G)} E(m) = E$.
\end{definition}

\begin{definition}
  We say that the set $\mathcal{M}(G)$ of moves in $G$ admits a \emph{Morpion marking} if
     there exists a bijective mapping $d \colon \mathcal{M}(G) \to V \setminus \Cross$ such that $d(m) \in m$.
\end{definition}

\begin{definition}
  A lattice graph $G$ is a \emph{Morpion 5D graph} if $\Cross \subset V$,
    $\mathcal{M}(G)$ covers $E$ and $\mathcal{M}(G)$ is 5D-disjoint.
  If $d$ is a selected Morpion marking of $G$, then we say that $G$ togther with $d$ is 
    a \emph{marked Morpion 5D graph}.
  The \emph{size} of Morpion 5D graph  is defined as the number of vertices minus $36$, that is minus the number of vertices in the \Cross.
 \end{definition}


%\label{def:disjoint}
\begin{figure}[h]
    \centering
    \includegraphics[width=0.592\textwidth]{figures/85.pdf}
     \caption{
     A marked Morpion 5D graph $G_{85}$ of size $85$.
	}
    \label{fig:85}
\end{figure}

\paragraph*{Comments on the definition of Morpion 5D graphs.} 
Figure~\ref{fig:85} contains an example of a marked Morpion 5D graph $G_{85}$. 
Every vertex of $G_{85}$ that is not in $\Cross$ is labelled with one of the four directions. 
For every move $m$ from $\mathcal{M}(G_{85})$ there exists exactly one vertex in $m$ 
  labelled with the direction of $m$.
This allows us to decode the selected marking of $G_{85}$.
The graph $G_{85}$ is not a Morpion 5D position,  because every Morpion 5D position admits the last move, characterized by the fact that the last vertex is of degree $1$ or $2$ and if it is
of degree $2$, then the neighbours must be located on a straight line. 
There is no such vertex in $G_{85}$

\begin{figure}
  \centering
    \includegraphics[width=0.495\textwidth]{figures/94.pdf}
    \includegraphics[width=0.495\textwidth]{figures/uncon_corrected.pdf}
  \caption{
    A Morpion 5D graph of size $94$ on the left side. 
    The example on the right side shows a nonconnected Morpion 5D graph,
      which may have arbitrarily large bounding box.
  }
  \label{fig:uncon}
\end{figure}

Figure~\ref{fig:uncon} contains examples of Morpion 5D graphs.
Neither of these graphs admit a marking.
The graph on the left has a bounding box $(5,2,0,1)$.
It follows from Theorem~\ref{thm:boxes} that the maximal size of a marked Morpion 5D graph with this 
  bounding box is at most $82$ (a calculation not listed in statement of Theorem~\ref{thm:boxes} shows that it is equal to $80$).
The size of this graph is $94$, hence it does not admit a marking.
The graph on the right has a connected component with five dots.
A marking would have to be a map that assigns all of these dots to a single move.
Therefore no marking exists for this graph.
 %\todo{We have to decide either for ``unordered Morpion 5D graph'' or ``Morpion 5D graph'' --- currently we have both} %(see Section~\ref{sec:linear} for definitions an  unordered Morpion 5D graph and unmarked unordered Morpion 5D graph).
 %\todo{Define the size of such a graph - number of vertices - $36$}.
%We will call every such graph an \emph{unordered Morpion 5T graph}. See section~\ref{sec:linear} for a formal definition.

\begin{remark}
%a) There are Morpion 5D graphs that do not correspond to Morpion 5D positions. %\todo{Unmarked defined?}
%Figure~\ref{fig:85} shows such an example. 
%\todo{Inline comments from Figure}
%\end{remark}
%
%\begin{remark}
%\noindent
%b) 
A Morpion 5T equivalent of the definition of an (unmarked) Morpion 5D graph was 
  used in~\cite{ijcai} to compute a bound for Morpion 5T.
% These are graphs that can be covered by four-segment lines that are segment-disjoint and such that $4\cdot \# V - \# E = 144$.
%We call such graphs \emph{unmarked unordered Morpion graphs} (see section~\ref{sec:linear} for a formal definition).
Considering this class for Morpion 5D  does not give useful bounds. There are two reasons why this method does not work.
\begin{enumerate}
\item These graphs need not to be connected and therefore the bounding box of such a graph
  can be arbitrarily large, see Figure \ref{fig:uncon} (right), 
\item Even if we insist on connectedness, there are examples of Morpion 5D graphs of size exceeding sizes in 
table \ref{tbl:boundingboxes}, see Figure~\ref{fig:uncon} (left). In this specific example, the graph has $94$ vertices.
\end{enumerate}
\end{remark}

\subsection{Definition of mixed integer programming problem}

Let $\mathcal{B}$ be a box that contains $\Cross$. 
We define a mixed integer programming problem whose solutions correspond to all Morpion 5D graphs with a bounding 
   box $\mathcal{B}$.
  
\begin{definition}  
  Let $B = (V_B, E_B)$ be a lattice graph with a vertex set $V_B = \mathcal{B}$ and an edge set $E_B$
    of all unit edges with vertices contained in $V_B$ (this is a maximal edge set for a lattice graph with set of vertices $\mathcal{B}$).  
 Let $ \{ \dt_v \colon v \in V_B \} \cup \{ \mv_{m, v} \colon m \in \mathcal{M}(B), v \in m \}$ be a set of structural binary variables (i.e. variables assuming values $0, 1$).
 
Below we define linear constraints \L{1} - \L{7}. Every constraint is accompanied by an explanation that refers to 
  the graph $G$ with marking $d$ constructed in Lemma \ref{lem:solutions}.

  \begin{enumerate}[label=\L{\arabic*}.]
  \item  For each $v \in Cross$,
  \[
    \dt_v = 1.
  \]
\noindent{\small Constraint \L{1} enforces that vertices of $\Cross$ are vertices of $G$ (see Lemma~\ref{lem:solutions}). }
\vspace{1mm}
  
  \item For each $m \in \mathcal{M}(B)$ and each $v \in m$ such that $v \in \Cross$,
  \[
    \mv_{m, v} = 0.
  \]
\noindent{\small Constraint \L{2} enforces that no vertices of $\Cross$ are marked by $d$. }
\vspace{1mm}

  \item For each $v \in V_B \setminus \Cross$, 
  \[ 
    \dt_v = \sum_{m \in \mathcal{M}(B) \colon v \in m} \mv_{m, v}.
  \]
\noindent{\small Constraint \L{3} enforces that vertices of $G$ that are not in $\Cross$ are 
  marked by exactly one move and there are no unmarked veritces outside of the $\Cross$. }
\vspace{1mm}

  \item For each $v \in V_B$ and each direction $d \in \D$,
  \[
  	\dt_v \geq \sum_{m \in \mathcal{M}(B) \colon m || d, v \in m} \sum_{w \in m} \mv_{m, w}.
  \]
\noindent{\small Constraint \L{4} enforces that parallel moves are vertex disjoint
  and that  every move in $G$ is placed on vertices of the graph. }
\vspace{1mm}

  \item A \emph{side} of a box $\mathcal{B}$ is one of four sets of vertices of $\mathcal{B}$ with maximal/minimal $x$/$y$ coordinates. For each side $S$ of $\mathcal{B}$,
  \[
  \sum_{v \in S} \dt_v \geq 1.
  \]
  \noindent{\small Constraint \L{5} enforces that $\mathcal{B}$ is the bounding box of $G$. }
\vspace{1mm}

\item For each $m \in \mathcal{M}(B)$ and every $v \in m$,
\[
	\mv_{m,v} = \mv_{s(m), s(v)},
\]
where $s(v)$, $s(m)$ denotes a vertex/move symmetric to $v$, $m$ with respect to the center of $\Cross$.

\vspace{1mm}
\noindent{\small Constraint \L{6} enforces center symmetry of $G$. }
\vspace{1mm}

  \end{enumerate}

\noindent  Let $\{ \ord_v \colon v \in V_B \}$ be a set of structural continuous variables.

\begin{enumerate}[label=\L{\arabic*}.]\addtocounter{enumi}{6}
\item For every $m \in \mathcal{M}(G)$, every $w, v \in m$, $w \neq v$,
\[
	\ord_v \geq \ord_w + 1 - 85 (1 - \mv_{m, v}).
\]
\noindent{\small Constraint \L{7} enforces that moves are placed in order. }
\vspace{1mm}
\end{enumerate}

  \label{def:mip}
\end{definition}

\begin{lemma}
\label{lem:solutions}
  Let $\dt_v$ and $\mv_{m, v}$ be a set of binary variables defined for a box $\mathcal{B}$.
  Assume that the variables satisfy conditions \L{1} - \L{5} of Definition~\ref{def:mip}.
  Let
 \[
    V = \{ v \in V_B \colon \dt_v = 1 \}
\]
 and
 \[
    E = \{ e \in E_B \colon \exists_{m \in \mathcal{M}(B)} \exists_{v \in m} \mv_{m, v} = 1 \wedge e  \in E(m) \},
  \]
  and $G = (V, E)$.
 Then $G$ is a Morpion 5D graph with a bounding box $\mathcal{B}$ and $G$ admits a Morpion marking $d$.

 If additionally the variables satisfy additionally condition \L{7}, then $G$ is a Morpion 5D position, i.e. there is actual Morpion 5D gameplay such that $G$ is a Morpion 5D graph corresponding to this gameplay.

 If additionally the variables satisfy condition \L{6}, then $G$ is center-symmetric. 
\end{lemma}
\begin{proof}  
  We will show that
  \begin{quote}
  (*) if $e \in E$, then there exists a unique $m_e \in \mathcal{M}(G)$ and $v_e \in m_e$ such that $e \in E(m_e)$ and $\mv_{m_e, v_e} = 1$. 
  \end{quote}
  By the defnition of $E$, if $e \in E$, then there exists $m \in \mathcal{M}(B)$ and $v \in m$ such that
    $e \in E(m)$ and $\mv_{m, v} = 1$. If there is another pair $m' \in \mathcal{M}(B)$ and $v' \in m'$ such 
    that $e \in E(m')$ and $\mv_{m', v'} = 1$, then $m || e || m'$ and by \L{4} for $w \in e$ we have
    $1 \geq \dt_w \geq \mv_{m, v} + \mv_{m', v'} = 2$. A contradiction that shows that $m$ and $v$ are unique.
  By the definition of $E$, if $m \in \mathcal{M}(B)$ and  $\mv_{m, v} = 1$, then $E(m) \subset E$ and
    $m \in \mathcal{M}(G)$.
  This concludes proof of (*).
  
  By the definition, $V \subset \mathbb{Z}^2$ and every element of $E$ is a unit edge.
  By \L{1}, $\Cross \subset V$.
  Let $e \in E$. By (*) there exists $m_e$ and $v_e$ such that $\mv_{m_e, v_e} = 1$ and $e \in E(m_e)$.
  If $v \in e$, then $v \in m_e$ and by \L{4}, we have $\dt_v \geq \mv_{m_e, v_e} = 1$ and hence $v \in V$.
  Therefore $\bigcup E \subset V$ and $G = (V, E)$ is a well defined lattice graph.
  
  From (*) for every $e \in E$, $e \in E(m_e)$. Hence the set of moves in $G$ covers the set of edges $E$.
  Assume that $e_1, e_2 \in E$ are parallel and $v \in e_1 \cap e_2$.
  By \L{4}, if $m_{e_1} \neq m_{e_2}$, then $1 \geq \dt_v \geq \mv_{m_{e_1}, v_{e_1}} 
  	+ \mv_{m_{e_2}, v_{e_2}} = 2$.
  Therefore $m_{e_1} = m_{e_2} = m$ and $e_1, e_2 \in E(m)$.
   Therefore if two moves $m_1, m_2 \in \mathcal{G}$ are parallel and have non-empty intersection, then
     $E(m_1) = E(m_2)$ so $m_1 = m_2$.
   This shows that parallel moves in $G$ are vertex disjoint. Hence $G$ is 5D-disjoint.
  
  By 5D-disjointness, if $e \in m \in \mathcal{M}(G)$, then $m = m_e$. Let $d \colon \mathcal{M}(G) \to V_B$ be a map defined by the formula $d(m) = v_e$. By (*), $\mv_{m_e, v_e} = 1$ and by \L{2} if $v_e \in \Cross$, then $\mv_{m_e, v_e} = 0$, hence $v_e  \in V_B \setminus \Cross$ and $d$ is into $V_B \setminus \Cross$.
Assume that $d(m_1) = d(m_2) = v$. If $m_1 \neq m_2$, then by \L{3}, $1 \geq \dt_v \geq \mv_{m_1, v} + \mv_{m_2, v} = 2$. It follows that $m_1 = m_2$. Therefore $d \colon \mathcal{M}(G) \to V_B$ is one-to-one.
  By \L{3}, the cardinality of $V_B \setminus \Cross$ is equal to the number of pairs $m, v$ such that $\mv_{m,v} = 1$, which by (*) is the number of moves in $\mathcal{M}(G)$.
  Therefore $d$ is a bijection and $G$ is a marked 5D graph. 
  
  By \L{5}, there is a vertex of $G$ on each side of $\mathcal{B}$, therefore $\mathcal{B}$ is the bounding box of $G$.
  
  If values of variables $\mv$ are symmetric, then graph $G$ is symmetric, hence \L{6} enforces a center symmetry of $G$.
  
  If we assume \L{7}, then each vertex $v \in V_G \setminus \Cross$ has assigned order variable $\ord_v$.
  Let $m \in \mathcal{M}(G)$ and let $v, w \in m, v \neq w$.
  If $\mv_{m, v} = 0$, then condition \L{7} is essentially void (\L{7} is triggered by $\mv_{m,v} = 1$).
  If $\mv_{m, v} = 1$, then $v = d(m)$ and \L{7} enforces that $\ord_{d(m)} \geq \ord_w$, where $w$ is 
    any vertex in $m$ that is different from $d(m)$.
  Therefore \L{7} implies that we can place moves in $G$ in order such that a vertex $d(m)$ marked by $m$ 
    is placed together with move $m$ in graph after all other vertices of $m$ were placed in $G$.
  This allows us to recover a gameplay that lead to Morpion 5D graph $G$.
\end{proof}

\begin{lemma}
  Let $G = (V, E)$ be a Morpion 5D graph with marking $d \colon \mathcal{M} \to V \setminus \Cross$
  and a bounding box $\mathcal{B}$.
  Let
  \[
    \dt_v = 
    \left\{
    \begin{array}{ll}
      1 & \text{ if } v \in V \\
      0 & \text{ otherwise }
    \end{array}
    \right.
  \]
  and 
  \[
    \mv_{m, v} = 
    \left\{
    \begin{array}{ll}
      1 & \text{ if } m \in \mathcal{M}(G) \text{ and } v = d(m) \\
      0 & \text{ otherwise }
    \end{array}
    \right.
  \]
  Then the set of variables $\dt_v$, $\mv_{m, v}$ satisfies conditions \L{1} - \L{5} of Definition~\ref{def:mip}.
\end{lemma}
\begin{proof}
  We verify conditions \L{1} - \L{5} of Definition~\ref{def:mip} one by one.
    
  \begin{enumerate}[label=\L{\arabic*}.]
   \item  By the definition of a Morpion 5D graph, $\Cross \subset V$, hence $\dt_v = 1$ for $v \in \Cross$.
  \item Since $d$ is into $V \setminus \Cross$ and $\mv_{m, v} = 1$ implies $v = d(m)$, we have
    $\mv_{m, v} = 0$ for $v \in \Cross$.
    
   \item If $v \in V \setminus \Cross$, then there exists exactly one $m \in \mathcal{M}(G)$ such that $d(m) = v$
     as $d$ is a bijection onto $V \setminus \Cross$.
   Hence  there exists exacly one move $m \in \mathcal{M}(B)$ that contains $v$,
     such that $\mv_{m, v} = 1$ as $\mv_{m,v} = 1$ iff $m \in \mathcal{M}(G)$ and $v = d(m)$.
   Therefore $\dt_v = 1 = \sum_{m \in \mathcal{M}(B) \colon v \in m} \mv_{m,v}$.
  If $v \in V_B \setminus V_G$, then $\dt_v$ and and all $\mv_{m, v}$ are equal to $0$.
  
  \item Let $v \in V_B$. If $v \not\in V$, then there is no $m \in \mathcal{M}(G)$ such that
     $d(m) = v$, hence $\dt_v$ and all $\mv_{m,v} = 0$.
     If $v \in V$ and $d \in \D$, then $\dt_v = 1$ and by 5D-disjointness of $G$ there exists
    at most one move 
    $m \in \mathcal{M}(G)$ such that $m || d$ and $v \in m$. 
    For $w \in m$ we have $\mv_{m, w} = 1$ iff $w = d(m)$.
    So the sum on the right hand side of inequality in L4 contains at most one non-zero element.
    
  \item Since $\mathcal{B}$ is the bounding box of $G$, for each side $S$ of $\mathcal{B}$ there
    exists a vertex $v \in V \cap S$. Then $\dt_v = 1$ and $\sum_{v \in S} \dt_v \geq 1$.
  \end{enumerate}
\end{proof}
